// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  vendor_owner
  owner
  vendor_admin
  sales
}

model Vendor {
  id                    String    @id @default(uuid())
  name                  String
  whatsappBusinessId    String?
  whatsappPhoneNumberId String?
  whatsappAccessToken   String?
  whatsappStatus        String    @default("not_configured")
  whatsappVerifiedAt    DateTime?
  whatsappLastError     String?
  createdAt             DateTime  @default(now())

  users          User[]
  leads          Lead[]
  conversations  Conversation[]
  templates      Template[]
  campaigns      Campaign[]
  messages       Message[]
  leadCategories LeadCategory[]
}

model User {
  id           String   @id @default(uuid())
  vendorId     String?
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  vendor            Vendor?            @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  refreshTokens     RefreshToken[]
  passwordResetOtps PasswordResetOtp[]
  messages          Message[]          @relation("UserMessages")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PasswordResetOtp {
  id        String   @id @default(uuid())
  userId    String
  otpHash   String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LeadCategory {
  id        String   @id @default(uuid())
  vendorId  String
  name      String
  parentId  String?
  createdAt DateTime @default(now())

  vendor   Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  parent   LeadCategory?  @relation("LeadCategoryTree", fields: [parentId], references: [id])
  children LeadCategory[] @relation("LeadCategoryTree")
}

model Lead {
  id              String    @id @default(uuid())
  vendorId        String
  name            String?
  phoneNumber     String
  status          String    @default("new")
  whatsappOptIn   Boolean   @default(true)
  optInSource     String?
  optInMessage    String?
  optInAt         DateTime?
  blockedAt       DateTime?
  lastContactedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  vendor        Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([vendorId, phoneNumber])
}

model Conversation {
  id               String    @id @default(uuid())
  vendorId         String
  leadId           String
  channel          String    @default("whatsapp")
  lastMessageAt    DateTime?
  isOpen           Boolean   @default(true)
  sessionStartedAt DateTime?
  sessionExpiresAt DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  lead     Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([vendorId, leadId])
}

model Template {
  id               String   @id @default(uuid())
  vendorId         String

  metaTemplateName String
  displayName      String
  category         String
  status           String   @default("draft")

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  vendor     Vendor                    @relation(fields: [vendorId], references: [id])
  languages  TemplateLanguage[]
  buttons    TemplateButton[]
  media      TemplateMedia[]
  campaigns  Campaign[]

  @@unique([vendorId, metaTemplateName])
  @@index([vendorId])
}


model TemplateButton {
  id         String @id @default(uuid())
  templateId String

  type       String
  text       String
  value      String?
  position   Int

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, position])
}


model TemplateMedia {
  id              String   @id @default(uuid())
  templateId      String

  // ðŸ”‘ Important additions
  language        String   // en_US, hi_IN
  position        Int      @default(0) // always 0 for header (future-proof)

  mediaType       String   // image | video | document
  s3Url           String
  whatsappMediaId String?

  uploadStatus    String   @default("pending") 
  // pending | uploaded | failed

  uploadError     String?
  uploadedAt      DateTime?

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, language, position])
}


model TemplateLanguage {
  id          String @id @default(uuid())
  templateId  String

  language    String
  body        String
  footerText  String?

  headerType  String?
  headerText  String?

  metaStatus  String  @default("draft")
  metaReason  String?
  metaId      String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  template Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, language])
}


model Campaign {
  id          String    @id @default(uuid())
  vendorId    String
  templateId  String?
  name        String?
  filters     Json?
  status      String    @default("draft")
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())

  vendor   Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  template Template? @relation(fields: [templateId], references: [id])
  messages Message[]
}

model Message {
  id                String    @id @default(uuid())
  vendorId          String
  conversationId    String
  campaignId        String?
  senderId          String?
  direction         String
  channel           String
  messageType       String?
  content           String?
  inboundPayload    Json?
  outboundPayload   Json?
  whatsappMessageId String   @unique
  replyToMessageId  String?
  status            String?
  errorCode         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  vendor       Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])
  sender       User?        @relation("UserMessages", fields: [senderId], references: [id])
}
